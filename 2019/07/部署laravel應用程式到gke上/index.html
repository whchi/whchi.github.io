<!DOCTYPE html>
<html lang="zh-tw">

<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta property="og:title" content=" 部署laravel應用程式到GKE上 &middot;  社畜人生" />
  
  <meta property="og:site_name" content="社畜人生" />
  <meta property="og:url" content="http://shachiku.life/2019/07/%E9%83%A8%E7%BD%B2laravel%E6%87%89%E7%94%A8%E7%A8%8B%E5%BC%8F%E5%88%B0gke%E4%B8%8A/" />
  <meta name="description" content="雜談與紀錄" />
  
  
  <meta property="og:type" content="article" />
  
  <meta property="og:article:published_time" content="2019-07-13T00:37:23&#43;08:00" />
  
  <meta property="og:article:tag" content="devops" />
  
  <meta property="og:article:tag" content="laravel" />
  
  <meta property="og:article:tag" content="k8s" />
  
  

  <title>
     部署laravel應用程式到GKE上 &middot;  社畜人生
  </title>

  <link rel="alternative stylesheet" href="http://shachiku.life/css/bootstrap.min.css" />
  <link rel="stylesheet" href="http://shachiku.life/css/font-awesome.min.css" />
  <link rel="stylesheet" href="http://shachiku.life/css/main.css" />
  <link rel="stylesheet" href="http://shachiku.life/css/github.css" />
  <link rel="stylesheet" href="http://shachiku.life/css/color-theme.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400" type="text/css">
  <link rel="shortcut icon" href="http://shachiku.life/images/favicon.ico" />
  <link rel="apple-touch-icon" href="http://shachiku.life/images/apple-touch-icon.png" />
  
  <link rel="stylesheet" href="http://shachiku.life/css/custom-hamburg.css">
  

  

  
  
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-N2DN7CD');</script>
    

  
</head>

<body>
  
    <header class="global-header" style="background-image:url(http://shachiku.life/images/background.jpg)">
      
      <section class="header-text">
        <div class="header-desc">
          <h1><a href="http://shachiku.life/">社畜人生</a></h1>
          
          <h2 class="tag-line">
            雜談與紀錄
          </h2>
          
        </div>
        
        <div class="navbar-container">
          
          <a class="btn btn-default navbar-item" href="http://shachiku.life/about">
            about
          </a>
          
          <a class="btn btn-default navbar-item" href="http://shachiku.life/tags">
            tags
          </a>
          
        </div>
        
        
        
        
        
        
        
        
        
        
        
      </section>
    </header>
    <main class="container">



<article>
  <header class="article-title">
    <h1 class="text-primary">部署laravel應用程式到GKE上</h1>
  </header>
  <div class="delimiter"></div>
  <section>
    <p><!-- raw HTML omitted -->內文僅記錄主要概念<!-- raw HTML omitted --></p>
<p>最近有機會接觸到 GKE 相關的東西, 趁記憶猶新趕緊紀錄一下, 流程大概為\</p>
<ol>
<li>開啟 <a href="https://cloud.google.com/kubernetes-engine/?hl=zh-tw">GKE instance</a>\</li>
<li>建立 &amp; push laravel app docker image to <a href="https://cloud.google.com/container-registry/">GCR</a>\</li>
<li>撰寫 yaml 檔並把程式部署到 GKE 上</li>
</ol>
<blockquote>
<p><a href="https://cloud.google.com/kubernetes-engine/">GKE</a>: 由 google 推出的 k8s engine 代管服務, 其他還有 AWS 的 EKS, M$ 的 AKS</p>
</blockquote>
<h2 id="前置作業">前置作業</h2>
<p><a href="https://cloud.google.com/kubernetes-engine/docs/quickstart?hl=zh-tw">GKE quickstart</a></p>
<h2 id="名詞解釋">名詞解釋</h2>
<p>在 k8s 中有多種類型的 <a href="https://kubernetes.io/docs/reference/kubectl/overview/#resource-types">resource objects</a>, 下面簡單介紹本文所需知道的類型</p>





<table class="table table-bordered">
<thead>
<tr>
<th style="text-align:left">資源名稱</th>
<th style="text-align:left">簡單說明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">pod</td>
<td style="text-align:left">組成的最小單位, 可由單一或是多個 container 組成, 撰寫 yaml 時建議直接用 deployment</td>
</tr>
<tr>
<td style="text-align:left">node</td>
<td style="text-align:left">實際提供 pods 環境的機器(虛擬 or 實體)</td>
</tr>
<tr>
<td style="text-align:left">deployment</td>
<td style="text-align:left">pods instance template</td>
</tr>
<tr>
<td style="text-align:left">service</td>
<td style="text-align:left">定義了如何連到 pods 的方式(protocol, port, kind)</td>
</tr>
<tr>
<td style="text-align:left">ingress</td>
<td style="text-align:left">think as L7 LBS(F5)</td>
</tr>
<tr>
<td style="text-align:left">configmap</td>
<td style="text-align:left">可在runtime時再把設定檔綁到特定的 pods 上, 讓設定更加彈性</td>
</tr>
<tr>
<td style="text-align:left">persistentvolume</td>
<td style="text-align:left">short for pv, think as external HD</td>
</tr>
<tr>
<td style="text-align:left">persistentvolumeclaims</td>
<td style="text-align:left">short for pvc, 存取pv的抽象層, 建好的 pv 需要透過 pvc 才能被掛載, 類似用 deploy 去掛 pod 的感覺</td>
</tr>
<tr>
<td style="text-align:left">service.NodePort</td>
<td style="text-align:left">讓叢集對外的最原始方式, 直接在 node 上開個 port</td>
</tr>
<tr>
<td style="text-align:left">service.ClusterIP</td>
<td style="text-align:left">預設的service type, 叢集中提供一個 cluster-internal ip讓叢集內/間的 pods 可以直接存取</td>
</tr>
<tr>
<td style="text-align:left">service.LoadBalancer</td>
<td style="text-align:left">一般對外的方式, 有需要的請參考<a href="https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer">官方說明</a></td>
</tr>
<tr>
<td style="text-align:left">Ingress</td>
<td style="text-align:left">不是 service type, 但能夠做到巷一台 L7 的服務掛給你對外</td>
</tr>
</tbody>
</table>


<h2 id="建立資源指令">建立資源指令</h2>
<p>有兩種方法使用<code>kubectl</code>告訴 k8s 你要建立的資源, 分別是<a href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/imperative-config/">create(命令式)</a>和<a href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/declarative-config/">apply(宣告式)</a></p>
<blockquote>
<p>這裡沒有找到比較好的解釋說明兩者的差異, 我個人是偏好不變的資源用 create, 因為兩種command 建立出來的資源是在 command 中是互斥的, 避免 apply 倒不會動的資源</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># 1. create resource</span>
kubectl create -f xxxx.yml
<span style="color:#75715e"># or</span>
kubectl apply -f xxxx.yml

<span style="color:#75715e"># 2. reload resource</span>
kubectl replace -f xxxx.yml <span style="color:#75715e"># use create</span>
<span style="color:#75715e"># or</span>
kubectl apply -f xxxx.yml <span style="color:#75715e"># use apply</span>
</code></pre></div><h2 id="預計建立架構">預計建立架構</h2>
<p><img src="/images/k8s-infa-sample.png" alt=""></p>
<h3 id="建立-laravel-app-image--push-to-gcr">建立 laravel app image &amp; push to GCR</h3>
<p><a href="https://laravel.com/docs/5.8/installation">安裝完laravel</a>之後寫個 Dockerfile build image, 參考如下</p>
<ul>
<li>Dockerfile.php</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker" data-lang="docker"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> php:7.3.3</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get update -y <span style="color:#f92672">&amp;&amp;</span> apt-get install -y openssl zip unzip git<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> curl -sS https://getcomposer.org/installer | php -- --install-dir<span style="color:#f92672">=</span>/usr/local/bin --filename<span style="color:#f92672">=</span>composer<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> docker-php-ext-install pdo mbstring json sockets<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> MyProject /app<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> composer install<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chown -R www-data:www-data /app/<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">USER</span><span style="color:#e6db74"> www-data</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> php artisan serve --host<span style="color:#f92672">=</span>0.0.0.0 --port<span style="color:#f92672">=</span><span style="color:#ae81ff">8000</span> <span style="color:#75715e">#實務上不會這樣做, 本文只是為了可以建立環境所以這樣做</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8000</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><ul>
<li>build &amp; push image</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker build -t phpapp:1.0.0 -f Dockerfile.php .
<span style="color:#75715e"># then</span>
docker push gcr.io/<span style="color:#f92672">{</span>your-gcp-project-name<span style="color:#f92672">}</span>/phpapp:1.0.0
<span style="color:#75715e"># 這裡以 gcr 為例, 推到 dockerhub 也可以, 總之要有一個本地連的到的地方</span>
</code></pre></div><h3 id="yaml">yaml</h3>
<p>這裡直接把 deploy 跟 service 寫在一起</p>
<ul>
<li>nginx-k8s.yml</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">data</span>:
  <span style="color:#f92672">nginx.conf</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">    user nginx;
</span><span style="color:#e6db74">    error_log  stderr warn;
</span><span style="color:#e6db74">    events {}
</span><span style="color:#e6db74">    http {
</span><span style="color:#e6db74">      server {
</span><span style="color:#e6db74">        listen 80;
</span><span style="color:#e6db74">        location / {
</span><span style="color:#e6db74">          proxy_pass http://phpapp-local:7777;
</span><span style="color:#e6db74">        }
</span><span style="color:#e6db74">      }
</span><span style="color:#e6db74">    }</span>    
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ConfigMap</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-config-local</span> <span style="color:#75715e"># configmap&#39;s name</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-local</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># 建立幾個 pods</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span> <span style="color:#75715e"># 建議需要設定 labels, 讓 service 可以透過 selector 選取</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx</span>
        <span style="color:#f92672">ports</span>:
          - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
        <span style="color:#f92672">resources</span>: <span style="color:#75715e"># 不設定也可, 但就不知道 k8s 會怎麼分配</span>
          <span style="color:#f92672">limits</span>: <span style="color:#75715e"># upper bound</span>
            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">50Mi</span>
          <span style="color:#f92672">requests</span>: <span style="color:#75715e"># lower bound</span>
            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">10m</span> <span style="color:#75715e"># 1000m = 1CPU</span>
        <span style="color:#f92672">volumeMounts</span>: <span style="color:#75715e"># 要 mount 的資源資訊</span>
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config-volume</span>
          <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/etc/nginx</span> <span style="color:#75715e"># 掛載到此 pod 上的路徑</span>
      <span style="color:#f92672">volumes</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">config-volume</span> <span style="color:#75715e"># 被 mount 的資源 key 與其設定</span>
        <span style="color:#f92672">configMap</span>:
          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-config-local</span> <span style="color:#75715e"># 對應上面的 configmap&#39;s name</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-local</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># service&#39;s port</span>
    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># pod&#39;s port</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span> <span style="color:#75715e"># 這裡用 select 對應到實際的 deployment</span>
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span> <span style="color:#75715e"># 要注意的是, Ingress 目前只支援 NodePort, 如果不用 Ingress 的話可使用 ClusterIP</span>
</code></pre></div><ul>
<li>php-k8s.yml</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">phpapp-local</span>
<span style="color:#f92672">spec</span>: <span style="color:#75715e"># pods instance</span>
  <span style="color:#f92672">strategy</span>:
    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span>
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">phpapp</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">terminationGracePeriodSeconds</span>: <span style="color:#ae81ff">10</span>
      <span style="color:#f92672">containers</span>:
      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">php</span>
        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gcr.io/{your-project-name}/phpapp:latest</span>
        <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
        <span style="color:#f92672">resources</span>:
          <span style="color:#f92672">limits</span>:
            <span style="color:#f92672">memory</span>: <span style="color:#ae81ff">100Mi</span>
          <span style="color:#f92672">requests</span>:
            <span style="color:#f92672">cpu</span>: <span style="color:#ae81ff">50m</span>
        <span style="color:#f92672">ports</span>:
        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8000</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">phpapp-local</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">7777</span> <span style="color:#75715e"># cluster 的 port</span>
    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8000</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">phpapp</span>
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</code></pre></div><ul>
<li>mysql.yml<br>
這裡用 cloudSQL, credential 的部分指的是 service account 金鑰, 有幾種方式設定</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#75715e"># 1. use kubectl (recommend)</span>
kubectl create secret generic <span style="color:#f92672">{</span>secret-name<span style="color:#f92672">}</span> --from-file /path/to/service-account.json
<span style="color:#75715e"># 2. use shell</span>
cat /path/to/service-account.json | base64
<span style="color:#75715e"># then paste to cloudsql-instance-credentials.yml</span>
</code></pre></div><p>先跑完 credential 再跑下面的 yml, 不然跑的時候會找不到</p>
<ul>
<li>cloudsql-instance-credentials.yml<br>
用 kubectl create 後也會建立此檔, 使用方法 2 的話可以先建立後再copy-paste</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Secret</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cloudsql-instance-credentials</span>
<span style="color:#f92672">type</span>: <span style="color:#ae81ff">Opaque</span> <span style="color:#75715e"># k8s 提供的一種非明碼儲存方式, 使用 `kubectl create secret generic`也會產生一樣的檔案</span>
<span style="color:#f92672">data</span>:
  <span style="color:#75715e"># base64 encoded service-account.json</span>
  <span style="color:#f92672">service-account.json</span>: <span style="color:#ae81ff">xxxxxxxxxxx=</span>
</code></pre></div><ul>
<li>cloudsql.yml</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cloudsql-proxy</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">component</span>: <span style="color:#ae81ff">cloudsql-proxy</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cloudsql-proxy</span>
          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gcr.io/cloudsql-docker/gce-proxy:1.14</span>
          <span style="color:#f92672">ports</span>:
            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">3306</span>
          <span style="color:#f92672">command</span>:
            - <span style="color:#ae81ff">/cloud_sql_proxy</span>
            - -<span style="color:#ae81ff">instances={gcp-project-name}:{cloud-sql-region}:{cloud-sql-database-name}=tcp:0.0.0.0:3306</span>
            - -<span style="color:#ae81ff">credential_file=/secrets/cloudsql/{your-service-account.json}</span> <span style="color:#75715e"># 具有讀寫 cloudsql database 權限的service account 金鑰檔</span>
          <span style="color:#f92672">volumeMounts</span>:
            - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cloudsql-instance-credentials</span>
              <span style="color:#f92672">mountPath</span>: <span style="color:#ae81ff">/secrets/cloudsql</span>
              <span style="color:#f92672">readOnly</span>: <span style="color:#66d9ef">true</span>
      <span style="color:#f92672">volumes</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cloudsql-instance-credentials</span>
          <span style="color:#f92672">secret</span>:
            <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">cloudsql-instance-credentials</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">cloudsql-proxy-service</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">ports</span>:
    - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">3306</span>
      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">3306</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">component</span>: <span style="color:#ae81ff">cloudsql-proxy</span>
</code></pre></div><ul>
<li>redis.yml</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-pod</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
  <span style="color:#f92672">template</span>:
    <span style="color:#f92672">metadata</span>:
      <span style="color:#f92672">labels</span>:
        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">redis-pod</span>
    <span style="color:#f92672">spec</span>:
      <span style="color:#f92672">containers</span>:
        - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis</span>
          <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis:5.0.5</span>
          <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">IfNotPresent</span>
          <span style="color:#f92672">ports</span>:
            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">6379</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">redis-svc</span> <span style="color:#75715e"># 記得把 laravel 的 env 中 redis 連線名稱改為這個</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">ports</span>:
    - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">6379</span>
      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">6379</span>
      <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">redis-pod</span>
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</code></pre></div><ul>
<li>ingress.yml<br>
不一定要用ingress, 也可以使用 LoadBalancer</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">kubernetes.io/ingress.global-static-ip-name</span>: <span style="color:#e6db74">&#34;external-ip-name&#34;</span> <span style="color:#75715e"># 預留外部靜態ip的名稱, @see [GCP保留靜態IP位址](https://cloud.google.com/compute/docs/ip-addresses/reserve-static-external-ip-address?hl=zh-tw)</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">backend</span>:
    <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">nginx-local</span> <span style="color:#75715e">#必須為 NodePort, 名稱為 nginx-k8s.yml 的 metadata</span>
    <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</code></pre></div><h2 id="備註">備註</h2>
<ol>
<li>nginx 跟 php 做分拆的話會有靜態檔案的問題, 這邊還沒想到一個很好的解法, 之前嘗試過的解法是用k8s的 pv(persistentVolume) + pvc(persistentVolumeClaim) 去掛可以掛 ROX(目前 GCE 還不支援) 的 disk 來做到多個 replicas 的時候也能正確 mount 新的靜態檔案</li>
<li>圖檔之類的東西應該不適合丟在 pv 做, 畢竟流量就是$$</li>
<li>上面的 yml 有蠻多細節沒補到, 如果有拿去 try 的要稍微研究一下拉~</li>
</ol>
<h2 id="references">References</h2>
<ul>
<li><a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/explore/explore-intro/">k8s overview</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod/">k8s pods concept</a></li>
<li><a href="https://godleon.github.io/">介紹 k8s 的中文部落格</a></li>
<li><a href="https://kubernetes.io/docs/reference/kubectl/overview/#resource-types">k8s resource types</a></li>
<li><a href="https://tachingchen.com/tw/blog/kubernetes-service/">k8s service 概念詳解</a></li>
<li><a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/">k8s label and selector</a></li>
<li><a href="https://github.com/Kong/kubernetes-ingress-controller/issues/85">(github issue) Ingress Controller for ClusterIP service type</a></li>
<li><a href="https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0">Ingress, ClusterIP and NodePort compression</a></li>
<li><a href="https://cloud.google.com/sql/docs/mysql/connect-kubernetes-engine?hl=zh-tw">gke connect to cloudsql setup</a></li>
<li><a href="https://stackoverflow.com/questions/47369351/kubectl-apply-vs-kubectl-create">kubectl create vs apply</a></li>
<li><a href="https://cloud.google.com/compute/docs/ip-addresses/reserve-static-external-ip-address?hl=zh-tw">GCP保留靜態IP位址</a></li>
<li><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#mount-options">k8s persistentVolume</a></li>
</ul>

  </section>
  <div class="clearfix">
    
    <div class="post-date pull-left">
      <span class="small">
        發佈時間
        2019-7-13
      </span>
    </div>
    
    <div class="pull-right">
      
      
      <span class="post-tag small"><a href="http://shachiku.life/tags/devops/">#devops</a></span>
      
      
      
      <span class="post-tag small"><a href="http://shachiku.life/tags/laravel/">#laravel</a></span>
      
      
      
      <span class="post-tag small"><a href="http://shachiku.life/tags/k8s/">#k8s</a></span>
      
      
    </div>
  </div>
  <footer>
    
    <i id="disqus-shortname" data-disqus-shortname=whcdc></i>
    
    <div class="delimiter"></div>
    <div id="disqus_thread"></div>
    <script type="application/javascript" src="/js/disqus.js"></script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
    
    
    
    <div class="delimiter"></div>
    <div class="pager-container">
      
      <a class="btn btn-primary btn-older-posts" href="http://shachiku.life/2019/06/%E5%AE%89%E8%A3%9D-fork-%E9%81%8E%E4%BE%86%E7%9A%84-composer-%E5%A5%97%E4%BB%B6/">
        <div>
          <span aria-hidden="true">&larr;</span>
        </div>
      </a>
      
      
      <a class="btn btn-primary btn-newer-posts" href="http://shachiku.life/2019/09/mac-connect-to-sql-server/">
        <div>
          <span aria-hidden="true">&rarr;</span>
        </div>
      </a>
      
    </div>
    
  </footer>
</article>
<div class="delimiter"></div>

</main>
<footer class="container global-footer">
  <div class="copyright-note pull-left">
    &copy; whchi 2018
  </div>
  <div class="sns-links hidden-print">
  
  
  
  
  
  
    <a rel="noopener noreferrer" href="https://github.com/whchi" target="_blank">
      <i class="fa fa-github"></i>
    </a>
  
  
  
  
  
  
    <a rel="noopener noreferrer" href="https://linkedin.com/in/wei-han-chi-615006110" target="_blank">
      <i class="fa fa-linkedin"></i>
    </a>
  
  
</div>

</footer>




</body>
</html>

