<!DOCTYPE html>
<html lang="zh-tw">

<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <meta property="og:title" content=" 部署laravel應用程式到GKE上 &middot;  雜談與紀錄" />
  
  <meta property="og:site_name" content="雜談與紀錄" />
  <meta property="og:url" content="https://whchi.github.io/posts/deploy-laravel-app-to-gke/" />
  
  
  <meta property="og:type" content="article" />
  
  <meta property="og:article:published_time" content="2019-07-13T00:37:23&#43;08:00" />
  
  <meta property="og:article:tag" content="devops" />
  
  <meta property="og:article:tag" content="GKE" />
  
  <meta property="og:article:tag" content="laravel" />
  
  <meta property="og:article:tag" content="k8s" />
  
  

  <title>
     部署laravel應用程式到GKE上 &middot;  雜談與紀錄
  </title>

  <link rel="alternative stylesheet" href="https://whchi.github.io/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://whchi.github.io/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://whchi.github.io/css/main.css" />
  <link rel="stylesheet" href="https://whchi.github.io/css/github.css" />
  <link rel="stylesheet" href="https://whchi.github.io/css/color-theme.css" />
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400" type="text/css">
  <link rel="shortcut icon" href="https://whchi.github.io/images/favicon.ico" />
  <link rel="apple-touch-icon" href="https://whchi.github.io/images/apple-touch-icon.png" />
  
  <link rel="stylesheet" href="https://whchi.github.io/css/custom-hamburg.css">
  

  

  
</head>

<body>
  
    <header class="global-header" style="background-image:url(https://whchi.github.io/images/background.jpg)">
      
      <section class="header-text">
        <div class="header-desc">
          <h1><a href="https://whchi.github.io/">雜談與紀錄</a></h1>
          
          <h4 class="tag-line">
            that/s all
          </h4>
          
        </div>
        
        <div class="navbar-container">
          
          <a class="btn btn-default navbar-item" href="https://whchi.github.io/pages/about">
            About
          </a>
          
        </div>
        
        
        
        
        
        
        
        
        
        
        
      </section>
    </header>
    <main class="container">



<article>
  <header class="article-title">
    <h1 class="text-primary">部署laravel應用程式到GKE上</h1>
  </header>
  <div class="delimiter"></div>
  <section>
    

<p><font color="red">內文僅記錄主要概念</font></p>

<p>最近有機會接觸到 GKE 相關的東西, 趁記憶猶新趕緊紀錄一下, 流程大概為<br />
1. 開啟 <a href="https://cloud.google.com/kubernetes-engine/?hl=zh-tw">GKE instance</a><br />
2. 建立 &amp; push laravel app docker image to <a href="https://cloud.google.com/container-registry/">GCR</a><br />
3. 撰寫 yaml 檔並把程式部署到 GKE 上</p>

<blockquote>
<p><a href="https://cloud.google.com/kubernetes-engine/">GKE</a>: 由 google 推出的 k8s engine 代管服務, 其他還有 AWS 的 EKS, M$ 的 AKS</p>
</blockquote>

<h2 id="前置作業">前置作業</h2>

<p><a href="https://cloud.google.com/kubernetes-engine/docs/quickstart?hl=zh-tw">GKE quickstart</a></p>

<h2 id="名詞解釋">名詞解釋</h2>

<p>在 k8s 中有多種類型的 <a href="https://kubernetes.io/docs/reference/kubectl/overview/#resource-types">resource objects</a>, 下面簡單介紹本文所需知道的類型</p>

<table>
<thead>
<tr>
<th align="left">資源名稱</th>
<th align="left">簡單說明</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">pod</td>
<td align="left">組成的最小單位, 可由單一或是多個 container 組成, 撰寫 yaml 時建議直接用 deployment</td>
</tr>

<tr>
<td align="left">node</td>
<td align="left">實際提供 pods 環境的機器(虛擬 or 實體)</td>
</tr>

<tr>
<td align="left">deployment</td>
<td align="left">pods instance template</td>
</tr>

<tr>
<td align="left">service</td>
<td align="left">定義了如何連到 pods 的方式(protocol, port, kind)</td>
</tr>

<tr>
<td align="left">ingress</td>
<td align="left">think as L7 LBS(F5)</td>
</tr>

<tr>
<td align="left">configmap</td>
<td align="left">可在runtime時再把設定檔綁到特定的 pods 上, 讓設定更加彈性</td>
</tr>

<tr>
<td align="left">persistentvolume</td>
<td align="left">short for pv, think as external HD</td>
</tr>

<tr>
<td align="left">persistentvolumeclaims</td>
<td align="left">short for pvc, 存取pv的抽象層, 建好的 pv 需要透過 pvc 才能被掛載, 類似用 deploy 去掛 pod 的感覺</td>
</tr>

<tr>
<td align="left">service.NodePort</td>
<td align="left">讓叢集對外的最原始方式, 直接在 node 上開個 port</td>
</tr>

<tr>
<td align="left">service.ClusterIP</td>
<td align="left">預設的service type, 叢集中提供一個 cluster-internal ip讓叢集內/間的 pods 可以直接存取</td>
</tr>

<tr>
<td align="left">service.LoadBalancer</td>
<td align="left">一般對外的方式, 有需要的請參考<a href="https://kubernetes.io/docs/concepts/services-networking/service/#loadbalancer">官方說明</a></td>
</tr>

<tr>
<td align="left">Ingress</td>
<td align="left">不是 service type, 但能夠做到巷一台 L7 的服務掛給你對外</td>
</tr>
</tbody>
</table>

<h2 id="建立資源指令">建立資源指令</h2>

<p>有兩種方法使用<code>kubectl</code>告訴 k8s 你要建立的資源, 分別是<a href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/imperative-config/">create(命令式)</a>和<a href="https://kubernetes.io/docs/tasks/manage-kubernetes-objects/declarative-config/">apply(宣告式)</a></p>

<blockquote>
<p>這裡沒有找到比較好的解釋說明兩者的差異, 我個人是偏好不變的資源用 create, 因為兩種command 建立出來的資源是在 command 中是互斥的, 避免 apply 倒不會動的資源</p>
</blockquote>

<pre><code class="language-sh"># 1. create resource
kubectl create -f xxxx.yml
# or
kubectl apply -f xxxx.yml

# 2. reload resource
kubectl replace -f xxxx.yml # use create
# or
kubectl apply -f xxxx.yml # use apply

</code></pre>

<h2 id="預計建立架構">預計建立架構</h2>

<p><img src="/images/k8s-infa-sample.png" alt="" /></p>

<h3 id="建立-laravel-app-image-push-to-gcr">建立 laravel app image &amp; push to GCR</h3>

<p><a href="https://laravel.com/docs/5.8/installation">安裝完laravel</a>之後寫個 Dockerfile build image, 參考如下</p>

<ul>
<li>Dockerfile.php</li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker" data-lang="docker"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> php:7.3.3</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get update -y <span style="color:#f92672">&amp;&amp;</span> apt-get install -y openssl zip unzip git<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> curl -sS https://getcomposer.org/installer | php -- --install-dir<span style="color:#f92672">=</span>/usr/local/bin --filename<span style="color:#f92672">=</span>composer<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> docker-php-ext-install pdo mbstring json sockets<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>COPY MyProject /app<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> composer install<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> chown -R www-data:www-data /app/<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>USER www-data<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span><span style="color:#e6db74"> php artisan serve --host=0.0.0.0 --port=8000 #實務上不會這樣做, 本文只是為了可以建立環境所以這樣做</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8000</span></code></pre></div>

<ul>
<li>build &amp; push image</li>
</ul>

<pre><code class="language-sh">docker build -t phpapp:1.0.0 -f Dockerfile.php .
# then
docker push gcr.io/{your-gcp-project-name}/phpapp:1.0.0
# 這裡以 gcr 為例, 推到 dockerhub 也可以, 總之要有一個本地連的到的地方
</code></pre>

<h3 id="yaml">yaml</h3>

<p>這裡直接把 deploy 跟 service 寫在一起</p>

<ul>
<li>nginx-k8s.yml</li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">apiVersion: v1
data:
  nginx.conf: <span style="color:#e6db74">|
</span><span style="color:#e6db74">    user nginx;</span>
    error_log  stderr warn;
    events {}
    http {
      server {
        listen <span style="color:#ae81ff">80</span>;

        location / {
          proxy_pass http://phpapp-local:<span style="color:#ae81ff">7777</span>;
        }
      }
    }
kind: ConfigMap
metadata:
  name: nginx-config-local <span style="color:#75715e"># configmap&#39;s name</span>
---
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: nginx-local
spec:
  replicas: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># 建立幾個 pods</span>
  template:
    metadata:
      labels:
        app: nginx <span style="color:#75715e"># 建議需要設定 labels, 讓 service 可以透過 selector 選取</span>
    spec:
      containers:
      - name: nginx
        image: nginx
        ports:
          - containerPort: <span style="color:#ae81ff">80</span>
        resources: <span style="color:#75715e"># 不設定也可, 但就不知道 k8s 會怎麼分配</span>
          limits: <span style="color:#75715e"># upper bound</span>
            memory: 50Mi
          requests: <span style="color:#75715e"># lower bound</span>
            cpu: 10m <span style="color:#75715e"># 1000m = 1CPU</span>
        volumeMounts: <span style="color:#75715e"># 要 mount 的資源資訊</span>
        - name: config-volume
          mountPath: /etc/nginx <span style="color:#75715e"># 掛載到此 pod 上的路徑</span>
      volumes:
      - name: config-volume <span style="color:#75715e"># 被 mount 的資源 key 與其設定</span>
        configMap:
          name: nginx-config-local <span style="color:#75715e"># 對應上面的 configmap&#39;s name</span>
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-local
spec:
  ports:
  - port: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># service&#39;s port</span>
    targetPort: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># pod&#39;s port</span>
  selector:
    app: nginx <span style="color:#75715e"># 這裡用 select 對應到實際的 deployment</span>
  type: NodePort <span style="color:#75715e"># 要注意的是, Ingress 目前只支援 NodePort, 如果不用 Ingress 的話可使用 ClusterIP</span></code></pre></div>

<ul>
<li>php-k8s.yml</li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: phpapp-local
spec: <span style="color:#75715e"># pods instance</span>
  strategy:
    type: RollingUpdate
  replicas: <span style="color:#ae81ff">1</span>
  template:
    metadata:
      labels:
        app: phpapp
    spec:
      terminationGracePeriodSeconds: <span style="color:#ae81ff">10</span>
      containers:
      - name: php
        image: gcr.io/{your-project-name}/phpapp:latest
        imagePullPolicy: IfNotPresent
        resources:
          limits:
            memory: 100Mi
          requests:
            cpu: 50m
        ports:
        - containerPort: <span style="color:#ae81ff">8000</span>
---
apiVersion: v1
kind: Service
metadata:
  name: phpapp-local
spec:
  ports:
  - port: <span style="color:#ae81ff">7777</span> <span style="color:#75715e"># cluster 的 port</span>
    targetPort: <span style="color:#ae81ff">8000</span>
  selector:
    app: phpapp
  type: ClusterIP</code></pre></div>

<ul>
<li>mysql.yml</li>
</ul>

<p>這裡用 cloudSQL, credential 的部分指的是 service account 金鑰, 有幾種方式設定</p>

<pre><code class="language-sh"># 1. use kubectl (recommend)
kubectl create secret generic {secret-name} --from-file /path/to/service-account.json
# 2. use shell
cat /path/to/service-account.json | base64
# then paste to cloudsql-instance-credentials.yml
</code></pre>

<p>先跑完 credential 再跑下面的 yml, 不然跑的時候會找不到</p>

<ul>
<li>cloudsql-instance-credentials.yml (用 kubectl create 後也會建立此檔, 使用方法 2 的話可以先建立後再copy-paste)</li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">apiVersion: v1
kind: Secret
metadata:
  name: cloudsql-instance-credentials
type: Opaque <span style="color:#75715e"># k8s 提供的一種非明碼儲存方式, 使用 `kubectl create secret generic`也會產生一樣的檔案</span>
data:
  <span style="color:#75715e"># base64 encoded service-account.json</span>
  service-account.json: xxxxxxxxxxx=</code></pre></div>

<ul>
<li>cloudsql.yml</li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: cloudsql-proxy
spec:
  replicas: <span style="color:#ae81ff">1</span>
  template:
    metadata:
      labels:
        component: cloudsql-proxy
    spec:
      containers:
        - name: cloudsql-proxy
          image: gcr.io/cloudsql-docker/gce-proxy:<span style="color:#ae81ff">1.14</span>
          ports:
            - containerPort: <span style="color:#ae81ff">3306</span>
          command:
            - /cloud_sql_proxy
            - -instances={gcp-project-name}:{cloud-sql-region}:{cloud-sql-database-name}=tcp:<span style="color:#ae81ff">0.0</span>.<span style="color:#ae81ff">0.0</span>:<span style="color:#ae81ff">3306</span>
            - -credential_file=/secrets/cloudsql/{your-service-account.json} <span style="color:#75715e"># 具有讀寫 cloudsql database 權限的service account 金鑰檔</span>
          volumeMounts:
            - name: cloudsql-instance-credentials
              mountPath: /secrets/cloudsql
              readOnly: <span style="color:#66d9ef">true</span>
      volumes:
        - name: cloudsql-instance-credentials
          secret:
            secretName: cloudsql-instance-credentials
---
apiVersion: v1
kind: Service
metadata:
  name: cloudsql-proxy-service
spec:
  ports:
    - protocol: TCP
      port: <span style="color:#ae81ff">3306</span>
      targetPort: <span style="color:#ae81ff">3306</span>
  selector:
    component: cloudsql-proxy</code></pre></div>

<ul>
<li>redis.yml</li>
</ul>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: redis-pod
spec:
  replicas: <span style="color:#ae81ff">1</span>
  template:
    metadata:
      labels:
        app: redis-pod
    spec:
      containers:
        - name: redis
          image: redis:<span style="color:#ae81ff">5.0</span>.<span style="color:#ae81ff">5</span>
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: <span style="color:#ae81ff">6379</span>
---
apiVersion: v1
kind: Service
metadata:
  name: redis-svc <span style="color:#75715e"># 記得把 laravel 的 env 中 redis 連線名稱改為這個</span>
spec:
  ports:
    - port: <span style="color:#ae81ff">6379</span>
      targetPort: <span style="color:#ae81ff">6379</span>
      protocol: TCP
  selector:
    app: redis-pod
  type: ClusterIP</code></pre></div>

<ul>
<li>ingress.yml</li>
</ul>

<p>不一定要用ingress, 也可以使用 LoadBalancer
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress
  annotations:
    kubernetes.io/ingress.global-static-ip-name: <span style="color:#e6db74">&#34;external-ip-name&#34;</span> <span style="color:#75715e"># 預留外部靜態ip的名稱, @see [GCP保留靜態IP位址](https://cloud.google.com/compute/docs/ip-addresses/reserve-static-external-ip-address?hl=zh-tw)</span>
spec:
  backend:
    serviceName: nginx-local <span style="color:#75715e">#必須為 NodePort, 名稱為 nginx-k8s.yml 的 metadata</span>
    servicePort: <span style="color:#ae81ff">80</span></code></pre></div></p>

<h2 id="備註">備註</h2>

<p>nginx 跟 php 做分拆的話會有靜態檔案的問題, 這邊還沒想到一個很好的解法, 之前嘗試過的解法是用k8s的 pv(persistentVolume) + pvc(persistentVolumeClaim) 去掛可以掛 ROX(目前 GCE 還不支援) 的 disk 來做到多個 replicas 的時候也能正確 mount 新的靜態檔案</p>

<p>不過圖檔之類的東西應該不適合丟在 pv 做, 畢竟流量就是$$</p>

<p>上面的 yml 有蠻多細節沒補到, 如果有拿去 try 的要稍微研究一下拉~</p>

<h2 id="references">References</h2>

<ul>
<li><a href="https://kubernetes.io/docs/tutorials/kubernetes-basics/explore/explore-intro/">k8s overview</a></li>
<li><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod/">k8s pods concept</a></li>
<li><a href="https://godleon.github.io/">介紹 k8s 的中文部落格</a></li>
<li><a href="https://kubernetes.io/docs/reference/kubectl/overview/#resource-types">k8s resource types</a></li>
<li><a href="https://tachingchen.com/tw/blog/kubernetes-service/">k8s service 概念詳解</a></li>
<li><a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/">k8s label and selector</a></li>
<li><a href="https://github.com/Kong/kubernetes-ingress-controller/issues/85">(github issue) Ingress Controller for ClusterIP service type</a></li>
<li><a href="https://medium.com/google-cloud/kubernetes-nodeport-vs-loadbalancer-vs-ingress-when-should-i-use-what-922f010849e0">Ingress, ClusterIP and NodePort compression</a></li>
<li><a href="https://cloud.google.com/sql/docs/mysql/connect-kubernetes-engine?hl=zh-tw">gke connect to cloudsql setup</a></li>
<li><a href="https://stackoverflow.com/questions/47369351/kubectl-apply-vs-kubectl-create">kubectl create vs apply</a></li>
<li><a href="https://cloud.google.com/compute/docs/ip-addresses/reserve-static-external-ip-address?hl=zh-tw">GCP保留靜態IP位址</a></li>
<li><a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#mount-options">k8s persistentVolume</a></li>
</ul>

  </section>
  <div class="clearfix">
    
    <div class="post-date pull-left">
      <span class="small">
        發佈時間
        2019-7-13
      </span>
    </div>
    
    <div class="pull-right">
      
      
      <span class="post-tag small"><a href="https://whchi.github.io/tags/devops/">#Devops</a></span>
      
      
      
      <span class="post-tag small"><a href="https://whchi.github.io/tags/gke/">#Gke</a></span>
      
      
      
      <span class="post-tag small"><a href="https://whchi.github.io/tags/laravel/">#Laravel</a></span>
      
      
      
      <span class="post-tag small"><a href="https://whchi.github.io/tags/k8s/">#K8s</a></span>
      
      
    </div>
  </div>
  <footer>
    
    <i id="disqus-shortname" data-disqus-shortname=whcdc></i>
    
    <div class="delimiter"></div>
    <div id="disqus_thread"></div>
    <script type="application/javascript" src="/js/disqus.js"></script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
    
    
    
    <div class="delimiter"></div>
    <div class="pager-container">
      
      <a class="btn btn-primary btn-older-posts disabled" href="#">
        <div>
          <span aria-hidden="true">&#10006;</span> 已是最舊的文章
        </div>
      </a>
      
      
      <a class="btn btn-primary btn-newer-posts" href="https://whchi.github.io/posts/install-custom-composer-package/">
        <div>
          下一篇 <span aria-hidden="true">&rarr;</span>
        </div>
      </a>
      
    </div>
    
  </footer>
</article>
<div class="delimiter"></div>

  </main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
      &copy; whchi 2018
    </div>
    <div class="sns-links hidden-print">
  
  
  
  
  
  
  
  
  
  
  
  
</div>

  </footer>

  
  
  
  
</body>
</html>

